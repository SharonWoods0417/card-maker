# 常见问题和解决方案

## 🔄 无限循环问题

### **问题现象**
- 终端显示大量HMR更新：`[vite] hmr update /src/components/ExportSection.tsx (x100+)`
- 浏览器卡顿或无响应
- 开发服务器性能下降

### **根本原因**
1. **useCallback依赖项不稳定**：`[words]` 数组引用在每次渲染时都可能改变
2. **useEffect依赖项过于敏感**：依赖整个数组导致频繁触发
3. **state更新触发连锁反应**：一个state变化导致其他state连续变化

### **解决方案**
```typescript
// ❌ 错误写法 - 会导致无限循环
const handleFunction = React.useCallback(async () => {
  // ...
}, [words]); // words数组引用可能频繁变化

// ❌ 也会导致无限循环 - JSON.stringify每次都创建新字符串
}, [words.length, JSON.stringify(words.map(w => w.word + w.ipa))]);

// ✅ 正确写法 - 使用稳定的依赖项
const wordsStableKey = React.useMemo(() => {
  return words.map(w => `${w.word}_${w.ipa}_${w.ipaImage ? 'img' : 'txt'}`).join('|');
}, [words]);

const handleFunction = React.useCallback(async () => {
  // ...
}, [words.length, wordsStableKey]); // 使用useMemo缓存的稳定key
```

### **检查清单**
- [ ] 所有useCallback依赖项都是原始值或稳定引用
- [ ] useEffect依赖项使用最小必需集合
- [ ] state更新不会触发无限循环
- [ ] useMemo用于缓存复杂计算

## 📐 PDF布局居中问题

### **问题现象**
- 网页预览正常，PDF中元素不居中
- 文本或图片偏左显示
- CSS居中属性在PDF中无效

### **根本原因**
PDF渲染引擎对CSS的支持与浏览器不同：
- `textAlign: 'center'` 对图片无效
- `margin: auto` 在某些情况下不生效
- Flexbox支持有限

### **解决方案**

#### **文本居中**
```typescript
// ✅ 推荐方法
textContainer: {
  display: 'flex',
  justifyContent: 'center',
  alignItems: 'center',
  textAlign: 'center', // 双重保险
}
```

#### **图片居中**
```typescript
// ❌ 复杂方法 - 在某些PDF渲染引擎中不稳定
imageContainer: {
  display: 'flex',
  flexDirection: 'row',
  justifyContent: 'center',
  alignItems: 'center',
},
image: {
  alignSelf: 'center',
}

// ✅ ChatGPT推荐的简单可靠方法
imageContainer: {
  width: '100%',
  marginBottom: '4mm',
  // 移除复杂的flex布局
},
image: {
  width: '60mm',
  height: '8mm',
  objectFit: 'contain',
  marginLeft: 'auto',
  marginRight: 'auto', // 最可靠的居中方法
}
```

### **调试技巧**
```typescript
// 开启DEBUG模式查看元素边界
const DEBUG = true;

// 在样式中添加调试边框
border: DEBUG ? '1pt dashed #ff0000' : undefined,
```

## 🛡️ 预防措施

### **代码规范**
1. **永远使用稳定的依赖项**
2. **优先使用原始值而非对象/数组作为依赖**
3. **为关键函数添加详细注释**
4. **定期检查终端HMR更新频率**

### **文件结构**
```
src/components/ExportSection.tsx
├── 无限循环预防注释 ✓
├── PDF布局说明注释 ✓
└── DEBUG模式开关 ✓
```

## 📝 维护记录

- **2024-12-27**: 🔧 **彻底修复无限循环问题**
  - 原因：`JSON.stringify()`在依赖项中每次都创建新字符串
  - 解决：使用`useMemo`缓存稳定的`wordsStableKey`
  - 修复文件：`src/components/ExportSection.tsx:175`

- **2024-12-27**: 🎯 **解决PDF音标居中问题（尝试中）**
  - 方案一：`marginLeft: 'auto'` + `marginRight: 'auto'` ❌ 无效
  - 方案二：**双层嵌套容器居中**（当前测试中）
    - 外层：`justifyContent: 'center'` + `alignItems: 'center'`
    - 内层：`ipaWrapper`容器，固定尺寸 + Flex居中
  - 修复文件：`src/components/ExportSection.tsx:441`
  
- **2024-12-27**: 📚 **完善问题文档**
  - 新增：无限循环和PDF布局的详细解决方案
  - 文件：`doc/常见问题和解决方案.md`

---

**重要提醒**：遇到类似问题时，请先查阅此文档，避免重复调试！ 